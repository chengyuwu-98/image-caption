# steps:
# #step 1
# - name: 'gcr.io/cloud-builders/docker' 
#   entrypoint: 'bash'
#   args: [
#    '-c', 
#    'docker pull us.gcr.io/image-347015/imageaudio || exit 0'
#   ]
# #step 2
# - name: 'gcr.io/cloud-builders/docker'
#   args: ['build','-t','us.gcr.io/image-347015/imageaudio:latest','.']

# # step3 
# - name: 'gcr.io/cloud-builders/docker'
#   args: ['push','us.gcr.io/image-347015/imageaudio:latest']

# #step 4
# - name: 'gcr.io/cloud-builders/kubectl'
#   args: [
#    'rollout', 
#    'restart', 
#    'deployment/imageaudio'
#    #'container-regression=us.gcr.io/regression-flask/container-regression:latest'
#   ]
#   env:
#   - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
#   - 'CLOUDSDK_CONTAINER_CLUSTER=image'


steps:
#step 1
- name: 'gcr.io/cloud-builders/docker' 
  entrypoint: 'bash'
  args: [
   '-c', 
   'docker pull gcr.io/image-347015/imageaudio:latest || exit 0'
  ]
#step 2
- name: gcr.io/cloud-builders/docker
  args: [
   'build', 
   '-t', 
   'gcr.io/image-347015/imageaudio:origin',
   '-t', 
   'gcr.io/image-347015/imageaudio:latest',
   '.'
  ]
#step 3
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'k8s/deployment.yaml',
         'apply', '-f', 'k8s/service.yaml']

  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=image'
#step 4
- name: 'gcr.io/cloud-builders/kubectl'
  args: [
   'set', 
   'image', 
   'deployment', 
   'imageaudio', 
   'imageaudio=gcr.io/image-347015/imageaudio:origin'
  ]
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=image'
# push images to Google Container Registry with tags
images: [
   'gcr.io/image-347015/imageaudio:origin',
   'gcr.io/image-347015/imageaudio:latest'
  ]  
